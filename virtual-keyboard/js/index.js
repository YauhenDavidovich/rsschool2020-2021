/* eslint-disable */
const ru = [
  {
    small: 'CapsLock',
    shift: null,
    code: 'CapsLock',
    audio: '../../assets/sounds/caps.mp3'
  },
  {
    small: '—ë',
    shift: '–Å',
    code: 'Backquote',
  },
  {
    small: '1',
    shift: '!',
    code: 'Digit1',
  },
  {
    small: '2',
    shift: '"',
    code: 'Digit2',
  },
  {
    small: '3',
    shift: '‚Ññ',
    code: 'Digit3',
  },
  {
    small: '4',
    shift: ';',
    code: 'Digit4',
  },
  {
    small: '5',
    shift: '%',
    code: 'Digit5',
  },
  {
    small: '6',
    shift: ':',
    code: 'Digit6',
  },
  {
    small: '7',
    shift: '?',
    code: 'Digit7',
  },
  {
    small: '8',
    shift: '*',
    code: 'Digit8',
  },
  {
    small: '9',
    shift: '(',
    code: 'Digit9',
  },
  {
    small: '0',
    shift: ')',
    code: 'Digit0',
  },
  {
    small: '-',
    shift: '_',
    code: 'Minus',
  },
  {
    small: '=',
    shift: '+',
    code: 'Equal',
  },
  {
    small: 'Backspace',
    shift: null,
    code: 'Backspace',
    audio: '../../assets/sounds/delete.wav',
  },
  {
    small: 'Delete',
    shift: null,
    code: 'Delete',
    audio: 'Delete',
  },
  {
    small: 'Tab',
    shift: null,
    code: 'Tab',
  },
  {
    small: '–π',
    shift: '–ô',
    code: 'KeyQ',
  },
  {
    small: '—Ü',
    shift: '–¶',
    code: 'KeyW',
  },
  {
    small: '—É',
    shift: '–£',
    code: 'KeyE',
  },
  {
    small: '–∫',
    shift: '–ö',
    code: 'KeyR',
  },
  {
    small: '–µ',
    shift: '–ï',
    code: 'KeyT',
  },
  {
    small: '–Ω',
    shift: '–ù',
    code: 'KeyY',
  },
  {
    small: '–≥',
    shift: '–ì',
    code: 'KeyU',
  },
  {
    small: '—à',
    shift: '–®',
    code: 'KeyI',
  },
  {
    small: '—â',
    shift: '–©',
    code: 'KeyO',
  },
  {
    small: '–∑',
    shift: '–ó',
    code: 'KeyP',
  },
  {
    small: '—Ö',
    shift: '–•',
    code: 'BracketLeft',
  },
  {
    small: '—ä',
    shift: '–™',
    code: 'BracketRight',
  },
  {
    small: 'Enter',
    shift: null,
    code: 'Enter',
  },
  {
    small: '—Ñ',
    shift: '–§',
    code: 'KeyA',
  },
  {
    small: '—ã',
    shift: '–´',
    code: 'KeyS',
  },
  {
    small: '–≤',
    shift: '–í',
    code: 'KeyD',
  },
  {
    small: '–∞',
    shift: '–ê',
    code: 'KeyF',
  },
  {
    small: '–ø',
    shift: '–ü',
    code: 'KeyG',
  },
  {
    small: '—Ä',
    shift: '–†',
    code: 'KeyH',
  },
  {
    small: '–æ',
    shift: '–û',
    code: 'KeyJ',
  },
  {
    small: '–ª',
    shift: '–õ',
    code: 'KeyK',
  },
  {
    small: '–¥',
    shift: '–î',
    code: 'KeyL',
  },
  {
    small: '–∂',
    shift: '–ñ',
    code: 'Semicolon',
  },
  {
    small: '—ç',
    shift: '–≠',
    code: 'Quote',
  },
  {
    small: '\\',
    shift: '/',
    code: 'Backslash',
  },
  {
    small: 'Shift',
    shift: null,
    code: 'ShiftLeft',
  },
  {
    small: '/',
    shift: '|',
    code: 'IntlBackslash',
  },
  {
    small: '—è',
    shift: '–Ø',
    code: 'KeyZ',
  },
  {
    small: '—á',
    shift: '–ß',
    code: 'KeyX',
  },
  {
    small: '—Å',
    shift: '–°',
    code: 'KeyC',
  },
  {
    small: '–º',
    shift: '–ú',
    code: 'KeyV',
  },
  {
    small: '–∏',
    shift: '–ò',
    code: 'KeyB',
  },
  {
    small: '—Ç',
    shift: '–¢',
    code: 'KeyN',
  },
  {
    small: '—å',
    shift: '–¨',
    code: 'KeyM',
  },
  {
    small: '–±',
    shift: '–ë',
    code: 'Comma',
  },
  {
    small: '—é',
    shift: '–Æ',
    code: 'Period',
  },
  {
    small: '.',
    shift: ',',
    code: 'Slash',
  },
  {
    small: 'Shift',
    shift: null,
    code: 'ShiftRight',
  },
  {
    small: 'Ctrl',
    shift: null,
    code: 'ControlLeft',
  },
  {
    small: 'Alt',
    shift: null,
    code: 'AltLeft',
  },
  {
    small: ' ',
    shift: null,
    code: 'Space',
  },
  {
    small: 'Alt',
    shift: null,
    code: 'AltRight',
  },
  {
    small: 'Ctrl',
    shift: null,
    code: 'ControlRight',
  },
  {
    small: '&larr;',
    shift: null,
    code: 'ArrowLeft',
  },
  {
    small: '&uarr;',
    shift: null,
    code: 'ArrowUp',
  },
  {
    small: '&darr;',
    shift: null,
    code: 'ArrowDown',
  },
  {
    small: '&rarr;',
    shift: null,
    code: 'ArrowRight',
  },
  {
    small: 'Win',
    shift: null,
    code: 'Win',
  },
];

const en = [
  {
    small: '`',
    shift: '~',
    code: 'Backquote',
  },
  {
    small: '1',
    shift: '!',
    code: 'Digit1',
  },
  {
    small: '2',
    shift: '@',
    code: 'Digit2',
  },
  {
    small: '3',
    shift: '#',
    code: 'Digit3',
  },
  {
    small: '4',
    shift: '$',
    code: 'Digit4',
  },
  {
    small: '5',
    shift: '%',
    code: 'Digit5',
  },
  {
    small: '6',
    shift: '^',
    code: 'Digit6',
  },
  {
    small: '7',
    shift: '&',
    code: 'Digit7',
  },
  {
    small: '8',
    shift: '*',
    code: 'Digit8',
  },
  {
    small: '9',
    shift: '(',
    code: 'Digit9',
  },
  {
    small: '0',
    shift: ')',
    code: 'Digit0',
  },
  {
    small: '-',
    shift: '_',
    code: 'Minus',
  },
  {
    small: '=',
    shift: '+',
    code: 'Equal',
  },
  {
    small: 'Backspace',
    shift: null,
    code: 'Backspace',
  },
  {
    small: 'Delete',
    shift: null,
    code: 'Delete',
  },
  {
    small: 'Tab',
    shift: null,
    code: 'Tab',
  },
  {
    small: 'q',
    shift: 'Q',
    code: 'KeyQ',
  },
  {
    small: 'w',
    shift: 'W',
    code: 'KeyW',
  },
  {
    small: 'e',
    shift: 'E',
    code: 'KeyE',
  },
  {
    small: 'r',
    shift: 'R',
    code: 'KeyR',
  },
  {
    small: 't',
    shift: 'T',
    code: 'KeyT',
  },
  {
    small: 'y',
    shift: 'Y',
    code: 'KeyY',
  },
  {
    small: 'u',
    shift: 'U',
    code: 'KeyU',
  },
  {
    small: 'i',
    shift: 'I',
    code: 'KeyI',
  },
  {
    small: 'o',
    shift: 'O',
    code: 'KeyO',
  },
  {
    small: 'p',
    shift: 'P',
    code: 'KeyP',
  },
  {
    small: '[',
    shift: '{',
    code: 'BracketLeft',
  },
  {
    small: ']',
    shift: '}',
    code: 'BracketRight',
  },
  {
    small: 'Enter',
    shift: null,
    code: 'Enter',
  },
  {
    small: 'CapsLock',
    shift: null,
    code: 'CapsLock',
  },
  {
    small: 'a',
    shift: 'A',
    code: 'KeyA',
  },
  {
    small: 's',
    shift: 'S',
    code: 'KeyS',
  },
  {
    small: 'd',
    shift: 'D',
    code: 'KeyD',
  },
  {
    small: 'f',
    shift: 'F',
    code: 'KeyF',
  },
  {
    small: 'g',
    shift: 'G',
    code: 'KeyG',
  },
  {
    small: 'h',
    shift: 'H',
    code: 'KeyH',
  },
  {
    small: 'j',
    shift: 'J',
    code: 'KeyJ',
  },
  {
    small: 'k',
    shift: 'K',
    code: 'KeyK',
  },
  {
    small: 'l',
    shift: 'L',
    code: 'KeyL',
  },
  {
    small: ';',
    shift: ':',
    code: 'Semicolon',
  },
  {
    small: "'",
    shift: '"',
    code: 'Quote',
  },
  {
    small: '\\',
    shift: '|',
    code: 'Backslash',
  },
  {
    small: 'Shift',
    shift: null,
    code: 'ShiftLeft',
  },
  {
    small: '<',
    shift: '>',
    code: 'IntlBackslash',
  },
  {
    small: 'z',
    shift: 'Z',
    code: 'KeyZ',
  },
  {
    small: 'x',
    shift: 'X',
    code: 'KeyX',
  },
  {
    small: 'c',
    shift: 'C',
    code: 'KeyC',
  },
  {
    small: 'v',
    shift: 'V',
    code: 'KeyV',
  },
  {
    small: 'b',
    shift: 'B',
    code: 'KeyB',
  },
  {
    small: 'n',
    shift: 'N',
    code: 'KeyN',
  },
  {
    small: 'm',
    shift: 'M',
    code: 'KeyM',
  },
  {
    small: ',',
    shift: '<',
    code: 'Comma',
  },
  {
    small: '.',
    shift: '>',
    code: 'Period',
  },
  {
    small: '/',
    shift: '?',
    code: 'Slash',
  },
  {
    small: 'Shift',
    shift: null,
    code: 'ShiftRight',
  },
  {
    small: 'Ctrl',
    shift: null,
    code: 'ControlLeft',
  },
  {
    small: 'Alt',
    shift: null,
    code: 'AltLeft',
  },
  {
    small: ' ',
    shift: null,
    code: 'Space',
  },
  {
    small: 'Alt',
    shift: null,
    code: 'AltRight',
  },
  {
    small: 'Ctrl',
    shift: null,
    code: 'ControlRight',
  },
  {
    small: '&larr;',
    shift: null,
    code: 'ArrowLeft',
  },
  {
    small: '&uarr;',
    shift: null,
    code: 'ArrowUp',
  },
  {
    small: '&darr;',
    shift: null,
    code: 'ArrowDown',
  },
  {
    small: '&rarr;',
    shift: null,
    code: 'ArrowRight',
  },
  {
    small: 'Win',
    shift: null,
    code: 'Win',
  },
];

let language = { ru, en }  


function set(name, value) {
  window.localStorage.setItem(name, JSON.stringify(value));
}

function get(name, subst = null) {
  return JSON.parse(window.localStorage.getItem(name) || subst);
}

function del(name) {
  localStorage.removeItem(name);
}


function create(el, classNames, child, parent, ...dataAttr) {
  let element = null;
  try {
    element = document.createElement(el);
  } catch (error) {
    throw new Error('Unable to create HTMLElement! Give a proper tag name');
  }

  if (classNames) element.classList.add(...classNames.split(' ')); // "class1 class2 class3"

  if (child && Array.isArray(child)) {
    child.forEach((childElement) => childElement && element.appendChild(childElement));
  } else if (child && typeof child === 'object') {
    element.appendChild(child);
  } else if (child && typeof child === 'string') {
    element.innerHTML = child;
  }

  if (parent) {
    parent.appendChild(element);
  }

  if (dataAttr.length) {
    dataAttr.forEach(([attrName, attrValue]) => {
      if (attrValue === '') {
        element.setAttribute(attrName, '');
      }
      if (attrName.match(/value|id|placeholder|cols|rows|autocorrect|spellcheck/)) {
        element.setAttribute(attrName, attrValue);
      } else {
        element.dataset[attrName] = attrValue;
      }
    });
  }
  return element;
}



const main = create('main', '',
  [create('h1', 'title', 'Virtual Keyboard'),
    create('h3', 'subtitle', 'with voice input'),
    create('p', 'hint', '–î–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —è–∑—ã–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–π <kbd>Ctrl</kbd> + <kbd>Alt</kbd>.'),
    create('p', 'hint', '–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ –ø–æ–∫–∞ —á—Ç–æ —Å—Ç–∞—Ä—Ç—É–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.')]);

class Keyboard {
  constructor(rowsOrder) {
    this.rowsOrder = rowsOrder;
    this.keysPressed = {};
    this.isCaps = false;
  }

  init(langCode) {
    this.keyBase = language[langCode];
    this.output = create('textarea', 'output', null, main,
      ['placeholder', '–ù–∞–∂–º–∏ —Å—é–¥–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø–µ—á–∞—Ç–∞—Ç—å'],
      ['rows', 5],
      ['cols', 50],
      ['spellcheck', false],
      ['autocorrect', 'off']);
      this.output = create('div', 'wrapper', null, main)
      ;
    
    this.container = create('div', 'keyboard', null, main, ['language', langCode]);
    document.body.prepend(main);
    return this;
  }

  generateLayout() {
    this.keyButtons = [];
    this.rowsOrder.forEach((row, i) => {
      const rowElement = create('div', 'keyboard__row', null, this.container, ['row', i + 1]);
      rowElement.style.gridTemplateColumns = `repeat(${row.length}, 1fr)`;
      row.forEach((code) => {
        const keyObj = this.keyBase.find((key) => key.code === code);
        if (keyObj) {
          const keyButton = new Key(keyObj);
          this.keyButtons.push(keyButton);
          rowElement.appendChild(keyButton.div);
        }
      });
    });

    document.addEventListener('keydown', this.handleEvent);
    document.addEventListener('keyup', this.handleEvent);
    this.container.onmousedown = this.preHandleEvent;
    this.container.onmouseup = this.preHandleEvent;
  }

  preHandleEvent = (e) => {
    e.stopPropagation();
    const keyDiv = e.target.closest('.keyboard__key');
    if (!keyDiv) return;
    const { dataset: { code } } = keyDiv;
    keyDiv.addEventListener('mouseleave', this.resetButtonState);
    this.handleEvent({ code, type: e.type });
  };

  // –§-—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π

  handleEvent = (e) => {
    if (e.stopPropagation) e.stopPropagation();
    const { code, type } = e;
    const keyObj = this.keyButtons.find((key) => key.code === code);
    if (!keyObj) return;
    this.output.focus();

    // –ù–ê–ñ–ê–¢–ò–ï –ö–ù–û–ü–ö–ò
    if (type.match(/keydown|mousedown/)) {
      if (!type.match(/mouse/)) e.preventDefault();


      if (code.match(/Shift/)) this.shiftKey = true;

      if (this.shiftKey) this.switchUpperCase(true);

      if (code.match(/Control|Alt|Caps/) && e.repeat) return;

      if (code.match(/Control/)) this.ctrKey = true;
      if (code.match(/Alt/)) this.altKey = true;
      if (code.match(/Control/) && this.altKey) this.switchLanguage();
      if (code.match(/Alt/) && this.ctrKey) this.switchLanguage();

      keyObj.div.classList.add('active');

      if (code.match(/Caps/) && !this.isCaps) {
        this.isCaps = true;
        this.switchUpperCase(true);
      } else if (code.match(/Caps/) && this.isCaps) {
        this.isCaps = false;
        this.switchUpperCase(false);
        keyObj.div.classList.remove('active');
      }


      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π —Å–∏–º–≤–æ–ª –º—ã –ø–∏—à–µ–º –≤ –∫–æ–Ω—Å–æ–ª—å (—Å–ø–µ—Ü –∏–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π)
      if (!this.isCaps) {
        // –µ—Å–ª–∏ –Ω–µ –∑–∞–∂–∞—Ç –∫–∞–ø—Å, —Å–º–æ—Ç—Ä–∏–º –Ω–µ –∑–∞–∂–∞—Ç –ª–∏ —à–∏—Ñ—Ç
        this.printToOutput(keyObj, this.shiftKey ? keyObj.shift : keyObj.small);
      } else if (this.isCaps) {
        // –µ—Å–ª–∏ –∑–∞–∂–∞—Ç –∫–∞–ø—Å
        if (this.shiftKey) {
          // –∏ –ø—Ä–∏ —ç—Ç–æ–º –∑–∞–∂–∞—Ç —à–∏—Ñ—Ç - —Ç–æ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–æ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–º –¥–∞–µ–º –≤–µ—Ä—Ö–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä
          this.printToOutput(keyObj, keyObj.sub.innerHTML ? keyObj.shift : keyObj.small);
        } else {
          // –∏ –ø—Ä–∏ —ç—Ç–æ–º –ù–ï –∑–∞–∂–∞—Ç —à–∏—Ñ—Ç - —Ç–æ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –±–µ–∑ —Å–ø–µ—Ü—Å–∏–≤–º–æ–ª–∞ –¥–∞–µ–º –≤–µ—Ä—Ö–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä
          this.printToOutput(keyObj, !keyObj.sub.innerHTML ? keyObj.shift : keyObj.small);
        }
      }
      this.keysPressed[keyObj.code] = keyObj;
    // –û–¢–ñ–ê–¢–ò–ï –ö–ù–û–ü–ö–ò
    } else if (e.type.match(/keyup|mouseup/)) {
      this.resetPressedButtons(code);
      // if (code.match(/Shift/) && !this.keysPressed[code])
      if (code.match(/Shift/)) {
        this.shiftKey = false;
        this.switchUpperCase(false);
      }
      if (code.match(/Control/)) this.ctrKey = false;
      if (code.match(/Alt/)) this.altKey = false;

      if (!code.match(/Caps/)) keyObj.div.classList.remove('active');
    }
  }

  resetButtonState = ({ target: { dataset: { code } } }) => {
    if (code.match('Shift')) {
      this.shiftKey = false;
      this.switchUpperCase(false);
      this.keysPressed[code].div.classList.remove('active');
    }
    if (code.match(/Control/)) this.ctrKey = false;
    if (code.match(/Alt/)) this.altKey = false;
    this.resetPressedButtons(code);
    this.output.focus();
  }

  resetPressedButtons = (targetCode) => {
    if (!this.keysPressed[targetCode]) return;
    if (!this.isCaps) this.keysPressed[targetCode].div.classList.remove('active');
    this.keysPressed[targetCode].div.removeEventListener('mouseleave', this.resetButtonState);
    delete this.keysPressed[targetCode];
  }

  switchUpperCase(isTrue) {
    // –§–ª–∞–≥ - —á—Ç–æ–±—ã –ø–æ–Ω–∏–º–∞—Ç—å, –º—ã –ø–æ–¥–Ω–∏–º–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä –∏–ª–∏ –æ–ø—É—Å–∫–∞–µ–º
    if (isTrue) {
      // –ú—ã –∑–∞–ø–∏—Å—ã–≤–∞–ª–∏ –Ω–∞—à–∏ –∫–Ω–æ–ø–∫–∏ –≤ keyButtons, —Ç–µ–ø–µ—Ä—å –º–æ–∂–µ–º –ª–µ–≥–∫–æ –∏—Ç–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ –Ω–∏–º
      this.keyButtons.forEach((button) => {
        // –ï—Å–ª–∏ —É –∫–Ω–æ–ø–∫–∏ –µ—Å—Ç—å —Å–ø–µ—Ü—Å–∏–≤–æ–ª - –º—ã –¥–æ–ª–∂–Ω—ã –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ç–∏–ª–∏
        if (button.sub) {
          // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ —ç—Ç–æ –Ω–µ –∫–∞–ø—Å, —Ç–æ–≥–¥–∞ –ø–æ–¥–Ω–∏–º–∞–µ–º —É —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤
          if (this.shiftKey) {
            button.sub.classList.add('sub-active');
            button.letter.classList.add('sub-inactive');
          }
        }
        // –ù–µ —Ç—Ä–æ–≥–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
        // –ò –µ—Å–ª–∏ –∫–∞–ø—Å, –∏ –Ω–µ —à–∏—Ñ—Ç, –∏ –∏–º–µ–Ω–Ω–æ –Ω–∞—à–∞ –∫–Ω–æ–ø–∫–∞ –±–µ–∑ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–∞
        if (!button.isFnKey && this.isCaps && !this.shiftKey && !button.sub.innerHTML) {
          // —Ç–æ–≥–¥–∞ –ø–æ–¥–Ω–∏–º–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞ letter
          button.letter.innerHTML = button.shift;
        // –ï—Å–ª–∏ –∫–∞–ø—Å –∏ –∑–∞–∂–∞—Ç —à–∏—Ñ—Ç
        } else if (!button.isFnKey && this.isCaps && this.shiftKey) {
          // —Ç–æ–≥–¥–∞ –æ–ø—É—Å–∫–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∏–º–æ–≤–ª–∞ letter
          button.letter.innerHTML = button.small;
        // –∞ –µ—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —à–∏—Ñ—Ç - —Ç–æ–≥–¥–∞ –ø–æ–¥–Ω–∏–º–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä —É –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
        // —Ç–æ–ª—å–∫–æ —É –∫–Ω–æ–ø–æ–∫, –±–µ–∑ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–∞ --- —Ç–∞–º —É–∂–µ –≤—ã—à–µ –æ—Ç—Ä–∞–±–æ—Ç–∞–ª –∫–æ–¥ –¥–ª—è –Ω–∏—Ö
        } else if (!button.isFnKey && !button.sub.innerHTML) {
          button.letter.innerHTML = button.shift;
        }
      });
    } else {
      // –æ–ø—É—Å–∫–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
      this.keyButtons.forEach((button) => {
        // –ù–µ —Ç—Ä–æ–≥–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
        // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª
        if (button.sub.innerHTML && !button.isFnKey) {
          // —Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ
          button.sub.classList.remove('sub-active');
          button.letter.classList.remove('sub-inactive');
          // –µ—Å–ª–∏ –Ω–µ –∑–∞–∂–∞—Ç –∫–∞–ø—Å
          if (!this.isCaps) {
            // —Ç–æ –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–º —Å–∏–º–≤–æ–ª–∞–º –Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä
            button.letter.innerHTML = button.small;
          } else if (!this.isCaps) {
            // –µ—Å–ª–∏ –∫–∞–ø—Å –∑–∞–∂–∞—Ç - —Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–µ—Ä—Ö–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä
            button.letter.innerHTML = button.shift;
          }
        // –µ—Å–ª–∏ —ç—Ç–æ –∫–Ω–æ–ø–∫–∞ –±–µ–∑ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–∞ (—Å–Ω–æ–≤–∞ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ)
        } else if (!button.isFnKey) {
          // —Ç–æ –µ—Å–ª–∏ –∑–∞–∂–∞—Ç –∫–∞–ø—Å
          if (this.isCaps) {
            // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–µ—Ä—Ö–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä
            button.letter.innerHTML = button.shift;
          } else {
            // –µ—Å–ª–∏ –æ—Ç–∂–∞—Ç –∫–∞–ø—Å - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä
            button.letter.innerHTML = button.small;
          }
        }
      });
    }
  }

  switchLanguage = () => {
    const langAbbr = Object.keys(language);
    let langIdx = langAbbr.indexOf(this.container.dataset.language);
    this.keyBase = langIdx + 1 < langAbbr.length ? language[langAbbr[langIdx += 1]]
      : language[langAbbr[langIdx -= langIdx]];

    this.container.dataset.language = langAbbr[langIdx];
    set('kbLang', langAbbr[langIdx]);

    this.keyButtons.forEach((button) => {
      const keyObj = this.keyBase.find((key) => key.code === button.code);
      if (!keyObj) return;
      button.shift = keyObj.shift;
      button.small = keyObj.small;
      if (keyObj.shift && keyObj.shift.match(/[^a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9]/g)) {
        button.sub.innerHTML = keyObj.shift;
      } else {
        button.sub.innerHTML = '';
      }
      button.letter.innerHTML = keyObj.small;
    });
    if (this.isCaps) this.switchUpperCase(true);
  }

  printToOutput(keyObj, symbol) {
    let cursorPos = this.output.selectionStart;
    const left = this.output.value.slice(0, cursorPos);
    const right = this.output.value.slice(cursorPos);
    const textHandlers = {
      Tab: () => {
        this.output.value = `${left}\t${right}`;
        cursorPos += 1;
      },
      ArrowLeft: () => {
        cursorPos = cursorPos - 1 >= 0 ? cursorPos - 1 : 0;
      },
      ArrowRight: () => {
        cursorPos += 1;
      },
      ArrowUp: () => {
        const positionFromLeft = this.output.value.slice(0, cursorPos).match(/(\n).*$(?!\1)/g) || [[1]];
        cursorPos -= positionFromLeft[0].length;
      },
      ArrowDown: () => {
        const positionFromLeft = this.output.value.slice(cursorPos).match(/^.*(\n).*(?!\1)/) || [[1]];
        cursorPos += positionFromLeft[0].length;
      },
      Enter: () => {
        this.output.value = `${left}\n${right}`;
        cursorPos += 1;
      },
      Delete: () => {
        this.output.value = `${left}${right.slice(1)}`;
      },
      Backspace: () => {
        this.output.value = `${left.slice(0, -1)}${right}`;
        cursorPos -= 1;
      },
      Space: () => {
        this.output.value = `${left} ${right}`;
        cursorPos += 1;
      },
    };
    if (textHandlers[keyObj.code]) textHandlers[keyObj.code]();
    else if (!keyObj.isFnKey) {
      cursorPos += 1;
      this.output.value = `${left}${symbol || ''}${right}`;
    }
    this.output.setSelectionRange(cursorPos, cursorPos);
  }
}

class Key {
  constructor({ small, shift, code}) {
    this.code = code;
    this.small = small;
    this.shift = shift;
    this.isFnKey = Boolean(small.match(/Ctrl|arr|Alt|Shift|Tab|Back|Del|Enter|Caps|Win/));
    

    if (shift && shift.match(/[^a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9]/)) {
      this.sub = create('div', 'sub', this.shift);
    } else {
      this.sub = create('div', 'sub', '');
    }
    

    this.letter = create('div', 'letter', small);
    this.div = create('div', 'keyboard__key', [this.sub, this.letter], null, ['code', this.code],
      this.isFnKey ? ['fn', 'true'] : ['fn', 'false']); // –º—ã –∑–∞–±—ã–ª–∏ —ç—Ç–æ—Ç –∞—Ç—Ä–∏–±—É—Ç –¥–æ–±–∞–≤–∏—Ç—å )) –æ–Ω –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã –≤ —Ä–∞–∑–º–µ—Ç–∫–µ —Å—Ç–∏–ª–∏–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫–ª–∞–≤–∏—à–∏ –æ—Ç–¥–µ–ª—å–Ω–æ
  }
}


const rowsOrder = [
  ['Backquote', 'Digit1', 'Digit2', 'Digit3', 'Digit4', 'Digit5', 'Digit6', 'Digit7', 'Digit8', 'Digit9', 'Digit0', 'Minus', 'Equal', 'Delete'],
  ['Tab', 'KeyQ', 'KeyW', 'KeyE', 'KeyR', 'KeyT', 'KeyY', 'KeyU', 'KeyI', 'KeyO', 'KeyP', 'BracketLeft', 'BracketRight', 'Backspace'],
  ['CapsLock', 'KeyA', 'KeyS', 'KeyD', 'KeyF', 'KeyG', 'KeyH', 'KeyJ', 'KeyK', 'KeyL', 'Semicolon', 'Quote', 'Backslash', 'Enter'],
  ['ShiftLeft', 'IntlBackslash', 'KeyZ', 'KeyX', 'KeyC', 'KeyV', 'KeyB', 'KeyN', 'KeyM', 'Comma', 'Period', 'Slash', 'ArrowUp', 'ShiftRight'],
  ['ControlLeft', 'Win', 'AltLeft', 'Space', 'AltRight', 'ArrowLeft', 'ArrowDown', 'ArrowRight', 'ControlRight'],
];

const lang = get('kbLang', '"ru"');


new Keyboard(rowsOrder).init(lang).generateLayout();



window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

const recognition = new SpeechRecognition();
recognition.interimResults = true;
recognition.lang = 'en-US';


const words = document.querySelector('.output');


recognition.addEventListener('result', e => {
  const transcript = Array.from(e.results)
    .map(result => result[0])
    .map(result => result.transcript)
    .join('');

    const poopScript = transcript.replace(/poop|poo|shit|dump/gi, 'üí©');
    
    console.log('poopScript')

    if (e.results[0].isFinal) {  
      words.value += " " + poopScript;
    }
});

recognition.addEventListener('end', recognition.start);

recognition.start();
alert("–£–≤–∞–∂–∞–µ–º—ã–π –ø—Ä–æ–≤–µ—Ä—è—é—â–∏–π! –û–≥—Ä–æ–º–Ω–∞—è –ø—Ä–æ—Å—å–±–∞ –∫ —Ç–µ–±–µ –æ—Ç–ª–æ–∂–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —ç—Ç–æ–≥–æ —Ç–∞—Å–∫–∞ –¥–æ 04.11.2020. –ë—É–¥—É –æ—á–µ–Ω—å –ø—Ä–∏–∑–Ω–∞—Ç–µ–ª–µ–Ω!")